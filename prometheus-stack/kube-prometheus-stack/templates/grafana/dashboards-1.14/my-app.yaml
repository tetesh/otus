{{- /*
Generated from 'my-app-monitoring' from my-app-monitoring.json
Do not change in-place! In order to change this file first read following link:
https://github.com/prometheus-community/helm-charts/tree/main/charts/kube-prometheus-stack/hack
*/ -}}
{{- $kubeTargetVersion := default .Capabilities.KubeVersion.GitVersion .Values.kubeTargetVersionOverride }}
{{- if and (or .Values.grafana.enabled .Values.grafana.forceDeployDashboards) (semverCompare ">=1.14.0-0" $kubeTargetVersion) (semverCompare "<9.9.9-9" $kubeTargetVersion) .Values.grafana.defaultDashboardsEnabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  namespace: {{ template "kube-prometheus-stack-grafana.namespace" . }}
  name: {{ printf "%s-%s" (include "kube-prometheus-stack.fullname" $) "my-app-monitoring" | trunc 63 | trimSuffix "-" }}
  annotations:
{{ toYaml .Values.grafana.sidecar.dashboards.annotations | indent 4 }}
  labels:
    {{- if $.Values.grafana.sidecar.dashboards.label }}
    {{ $.Values.grafana.sidecar.dashboards.label }}: {{ ternary $.Values.grafana.sidecar.dashboards.labelValue "1" (not (empty $.Values.grafana.sidecar.dashboards.labelValue)) | quote }}
    {{- end }}
    app: {{ template "kube-prometheus-stack.name" $ }}-grafana
{{ include "kube-prometheus-stack.labels" $ | indent 4 }}
data:
  my-app-monitoring.json: |-
    {{`{"annotations":{"list":[{"builtIn":1,"datasource":{"type":"grafana","uid":"-- Grafana --"},"enable":true,"hide":true,"iconColor":"rgba(0, 211, 255, 1)","name":"Annotations & Alerts","type":"dashboard"}]},"description":"My APP monitoring","editable":`}}{{ .Values.grafana.defaultDashboardsEditable }}{{`,"fiscalYearStartMonth":0,"graphTooltip":0,"id":244,"links":[],"liveNow":false,"panels":[{"datasource":{"type":"prometheus","uid":"prometheus"},"description":"","fieldConfig":{"defaults":{"color":{"mode":"thresholds"},"custom":{"align":"left","cellOptions":{"type":"auto"},"filterable":true,"inspect":false},"mappings":[],"min":0,"thresholds":{"mode":"absolute","steps":[{"color":"green","value":null}]},"unitScale":true},"overrides":[{"matcher":{"id":"byName","options":"Status"},"properties":[{"id":"mappings","value":[{"options":{"0":{"text":"DOWN"},"1":{"text":"UP"}},"type":"value"}]},{"id":"thresholds","value":{"mode":"absolute","steps":[{"color":"red","value":null},{"color":"green","value":1}]}},{"id":"custom.cellOptions","value":{"mode":"gradient","type":"color-background"}},{"id":"custom.width","value":76}]},{"matcher":{"id":"byName","options":"Code"},"properties":[{"id":"thresholds","value":{"mode":"absolute","steps":[{"color":"rgba(0, 0, 0, 0)","value":null},{"color":"green","value":200},{"color":"yellow","value":300},{"color":"red","value":500}]}},{"id":"custom.cellOptions","value":{"mode":"gradient","type":"color-background"}},{"id":"mappings","value":[{"options":{"0":{"text":""}},"type":"value"}]},{"id":"custom.width","value":78}]},{"matcher":{"id":"byName","options":"SSL"},"properties":[{"id":"mappings","value":[{"options":{"0":{"text":"NO"},"1":{"text":"OK"}},"type":"value"}]},{"id":"thresholds","value":{"mode":"absolute","steps":[{"color":"rgba(3, 3, 3, 0)","value":null},{"color":"red","value":0},{"color":"green","value":1}]}},{"id":"custom.cellOptions","value":{"mode":"gradient","type":"color-background"}},{"id":"custom.width","value":77}]},{"matcher":{"id":"byName","options":"Probe Duration (s)"},"properties":[{"id":"thresholds","value":{"mode":"absolute","steps":[{"color":"green","value":null},{"color":"yellow","value":0.8},{"color":"red","value":2}]}},{"id":"custom.cellOptions","value":{"mode":"basic","type":"gauge"}},{"id":"custom.filterable","value":false},{"id":"decimals","value":2},{"id":"max","value":3}]},{"matcher":{"id":"byName","options":"DNS Lookup Duration (s)"},"properties":[{"id":"thresholds","value":{"mode":"absolute","steps":[{"color":"green","value":null},{"color":"yellow","value":0.1},{"color":"red","value":0.2}]}},{"id":"max","value":0.3},{"id":"custom.cellOptions","value":{"mode":"basic","type":"gauge"}},{"id":"custom.filterable","value":false},{"id":"decimals","value":3}]},{"matcher":{"id":"byName","options":"Instance"},"properties":[{"id":"links","value":[{"targetBlank":true,"title":"${__data.fields.Instance}","url":"${__data.fields.Instance}"}]},{"id":"custom.width","value":276}]},{"matcher":{"id":"byName","options":"TLS Version"},"properties":[{"id":"custom.width","value":117}]}]},"gridPos":{"h":9,"w":24,"x":0,"y":0},"id":2,"options":{"cellHeight":"sm","footer":{"countRows":false,"fields":"","reducer":["sum"],"show":false},"showHeader":true,"sortBy":[{"desc":true,"displayName":"Code"}]},"pluginVersion":"10.3.3","repeatDirection":"h","targets":[{"datasource":{"type":"prometheus","uid":"prometheus"},"editorMode":"code","expr":"probe_success","format":"table","instant":true,"interval":"","legendFormat":"__auto","refId":"A"},{"datasource":{"type":"prometheus","uid":"prometheus"},"editorMode":"code","expr":"probe_http_status_code > 0","format":"table","instant":true,"interval":"","legendFormat":"","refId":"D"},{"datasource":{"type":"prometheus","uid":"prometheus"},"editorMode":"code","expr":"avg_over_time(probe_duration_seconds[1m])","format":"table","hide":false,"instant":false,"interval":"","intervalFactor":1,"legendFormat":"","refId":"E"},{"datasource":{"type":"prometheus","uid":"prometheus"},"expr":"probe_tls_version_info{job=~\"$job\", instance=~\"$instance\"}","format":"table","instant":true,"interval":"","legendFormat":"","refId":"F"},{"datasource":{"type":"prometheus","uid":"prometheus"},"editorMode":"code","expr":"avg_over_time(probe_dns_lookup_time_seconds[1m])","format":"table","instant":true,"interval":"","legendFormat":"","refId":"G"}],"title":"Probes Overview","transformations":[{"id":"seriesToColumns","options":{"byField":"instance"}},{"id":"organize","options":{"excludeByName":{"Time":true,"Time 1":true,"Time 2":true,"Time 3":true,"Time 4":true,"Time 5":true,"Time 6":true,"Time 7":true,"Time 8":true,"Value":false,"Value #A":false,"Value #B":false,"Value #F":true,"__name__":true,"__name__ 1":true,"__name__ 2":true,"__name__ 3":true,"__name__ 4":true,"__name__ 5":true,"__name__ 6":true,"__name__ 7":true,"job":true,"job 1":true,"job 2":true,"job 3":true,"job 4":true,"job 5":true,"job 6":true,"job 7":true,"job 8":true,"phase":true,"type":true,"type 1":true,"type 2":true,"type 3":true,"type 4":true,"type 5":true,"type 6":true,"type 7":true,"type 8":true,"version":false},"indexByName":{"Time 1":9,"Time 2":13,"Time 3":17,"Time 4":20,"Time 5":24,"Time 6":28,"Time 7":32,"Value #A":1,"Value #B":3,"Value #C":5,"Value #D":2,"Value #E":6,"Value #F":8,"Value #G":7,"__name__ 1":10,"__name__ 2":14,"__name__ 3":21,"__name__ 4":25,"__name__ 5":29,"instance":0,"job 1":11,"job 2":15,"job 3":18,"job 4":22,"job 5":26,"job 6":30,"type 1":12,"type 2":16,"type 3":19,"type 4":23,"type 5":27,"type 6":31,"version":4},"renameByName":{"Value":"Up","Value #A":"Status","Value #B":"SSL","Value #C":"SSL Cert Expiry (days)","Value #D":"Code","Value #E":"Probe Duration (s)","Value #F":"","Value #G":"DNS Lookup Duration (s)","Value #H":"Probe IP","instance":"Instance","type 6":"","version":"TLS Version"}}}],"transparent":true,"type":"table"},{"aliasColors":{},"bars":false,"columns":[],"dashLength":10,"dashes":false,"datasource":{"type":"prometheus","uid":"prometheus"},"fill":1,"fontSize":"100%","gridPos":{"h":7,"w":24,"x":0,"y":9},"id":3,"interval":"1m","legend":{"alignAsTable":true,"avg":false,"current":false,"max":false,"min":false,"rightSide":true,"show":true,"total":false,"values":false},"lines":true,"linewidth":1,"links":[],"nullPointMode":"null as zero","percentage":false,"pointradius":5,"points":false,"renderer":"flot","seriesOverrides":[],"showHeader":true,"sort":{"col":0,"desc":true},"spaceLength":10,"stack":false,"steppedLine":false,"styles":[{"alias":"Time","align":"auto","dateFormat":"YYYY-MM-DD HH:mm:ss","pattern":"Time","type":"hidden"},{"alias":"Running Pods","align":"auto","colors":[],"dateFormat":"YYYY-MM-DD HH:mm:ss","decimals":0,"link":false,"linkTargetBlank":false,"linkTooltip":"Drill down","linkUrl":"","pattern":"Value #A","thresholds":[],"type":"number","unit":"short"},{"alias":"CPU Usage","align":"auto","colors":[],"dateFormat":"YYYY-MM-DD HH:mm:ss","decimals":2,"link":false,"linkTargetBlank":false,"linkTooltip":"Drill down","linkUrl":"","pattern":"Value #B","thresholds":[],"type":"number","unit":"short"},{"alias":"CPU Requests","align":"auto","colors":[],"dateFormat":"YYYY-MM-DD HH:mm:ss","decimals":2,"link":false,"linkTargetBlank":false,"linkTooltip":"Drill down","linkUrl":"","pattern":"Value #C","thresholds":[],"type":"number","unit":"short"},{"alias":"CPU Requests %","align":"auto","colors":[],"dateFormat":"YYYY-MM-DD HH:mm:ss","decimals":2,"link":false,"linkTargetBlank":false,"linkTooltip":"Drill down","linkUrl":"","pattern":"Value #D","thresholds":[],"type":"number","unit":"percentunit"},{"alias":"CPU Limits","align":"auto","colors":[],"dateFormat":"YYYY-MM-DD HH:mm:ss","decimals":2,"link":false,"linkTargetBlank":false,"linkTooltip":"Drill down","linkUrl":"","pattern":"Value #E","thresholds":[],"type":"number","unit":"short"},{"alias":"CPU Limits %","align":"auto","colors":[],"dateFormat":"YYYY-MM-DD HH:mm:ss","decimals":2,"link":false,"linkTargetBlank":false,"linkTooltip":"Drill down","linkUrl":"","pattern":"Value #F","thresholds":[],"type":"number","unit":"percentunit"},{"alias":"Workload","align":"auto","colors":[],"dateFormat":"YYYY-MM-DD HH:mm:ss","decimals":2,"link":true,"linkTargetBlank":false,"linkTooltip":"Drill down","linkUrl":"/d/a164a7f0339f99e89cea5cb47e9be617/k8s-resources-workload?var-datasource=$datasource&var-cluster=$cluster&var-namespace=$namespace&var-workload=`}}{{ if .Values.grafana.sidecar.dashboards.enableNewTablePanelSyntax }}${__value.text}{{ else }}$__cell{{ end }}{{`&var-type=`}}{{ if .Values.grafana.sidecar.dashboards.enableNewTablePanelSyntax }}${__data.fields.workload_type}{{ else }}$__cell_2{{ end }}{{`","pattern":"workload","thresholds":[],"type":"number","unit":"short"},{"alias":"Workload Type","align":"auto","colors":[],"dateFormat":"YYYY-MM-DD HH:mm:ss","decimals":2,"link":false,"linkTargetBlank":false,"linkTooltip":"Drill down","linkUrl":"","pattern":"workload_type","thresholds":[],"type":"number","unit":"short"},{"alias":"","align":"auto","colors":[],"dateFormat":"YYYY-MM-DD HH:mm:ss","decimals":2,"pattern":"/.*/","thresholds":[],"type":"string","unit":"short"}],"targets":[{"datasource":{"uid":"$datasource"},"editorMode":"code","expr":"count(namespace_workload_pod:kube_pod_owner:relabel{namespace=\"app\"}) by (workload, workload_type)","format":"table","instant":true,"legendFormat":"","refId":"A"},{"datasource":{"uid":"$datasource"},"editorMode":"code","expr":"sum(\n  node_namespace_pod_container:container_cpu_usage_seconds_total:sum_irate{namespace=\"app\"}\n* on(namespace,pod)\n  group_left(workload, workload_type) namespace_workload_pod:kube_pod_owner:relabel{namespace=\"app\"}\n) by (workload, workload_type)\n","format":"table","instant":true,"legendFormat":"","refId":"B"},{"datasource":{"uid":"$datasource"},"editorMode":"code","expr":"sum(\n  kube_pod_container_resource_requests{namespace=\"app\", resource=\"cpu\"}\n* on(namespace,pod)\n  group_left(workload, workload_type) namespace_workload_pod:kube_pod_owner:relabel{namespace=\"app\"}\n) by (workload, workload_type)\n","format":"table","instant":true,"legendFormat":"","refId":"C"},{"datasource":{"uid":"$datasource"},"editorMode":"code","expr":"sum(\n  node_namespace_pod_container:container_cpu_usage_seconds_total:sum_irate{namespace=\"app\"}\n* on(namespace,pod)\n  group_left(workload, workload_type) namespace_workload_pod:kube_pod_owner:relabel{namespace=\"app\"}\n) by (workload, workload_type)\n/sum(\n  kube_pod_container_resource_requests{namespace=\"app\", resource=\"cpu\"}\n* on(namespace,pod)\n  group_left(workload, workload_type) namespace_workload_pod:kube_pod_owner:relabel{namespace=\"app\"}\n) by (workload, workload_type)\n","format":"table","instant":true,"legendFormat":"","refId":"D"},{"datasource":{"uid":"$datasource"},"editorMode":"code","expr":"sum(\n  kube_pod_container_resource_limits{namespace=\"app\", resource=\"cpu\"}\n* on(namespace,pod)\n  group_left(workload, workload_type) namespace_workload_pod:kube_pod_owner:relabel{namespace=\"app\"}\n) by (workload, workload_type)\n","format":"table","instant":true,"legendFormat":"","refId":"E"},{"datasource":{"uid":"$datasource"},"editorMode":"code","expr":"sum(\n  node_namespace_pod_container:container_cpu_usage_seconds_total:sum_irate{namespace=\"app\"}\n* on(namespace,pod)\n  group_left(workload, workload_type) namespace_workload_pod:kube_pod_owner:relabel{namespace=\"app\"}\n) by (workload, workload_type)\n/sum(\n  kube_pod_container_resource_limits{namespace=\"app\", resource=\"cpu\"}\n* on(namespace,pod)\n  group_left(workload, workload_type) namespace_workload_pod:kube_pod_owner:relabel{namespace=\"app\"}\n) by (workload, workload_type)\n","format":"table","instant":true,"legendFormat":"","refId":"F"}],"thresholds":[],"title":"CPU Quota","tooltip":{"shared":false,"sort":2,"value_type":"individual"},"transform":"table","type":"table-old","xaxis":{"mode":"time","show":true,"values":[]},"yaxes":[{"format":"short","logBase":1,"min":0,"show":true},{"format":"short","logBase":1,"show":false}]},{"aliasColors":{},"bars":false,"dashLength":10,"dashes":false,"datasource":{"type":"prometheus","uid":"prometheus"},"fieldConfig":{"defaults":{"unitScale":true},"overrides":[]},"fill":10,"fillGradient":0,"gridPos":{"h":7,"w":24,"x":0,"y":16},"hiddenSeries":false,"id":4,"interval":"1m","legend":{"alignAsTable":true,"avg":false,"current":false,"max":false,"min":false,"rightSide":true,"show":true,"total":false,"values":false},"lines":true,"linewidth":0,"links":[],"nullPointMode":"null as zero","options":{"alertThreshold":true},"percentage":false,"pluginVersion":"10.3.3","pointradius":5,"points":false,"renderer":"flot","seriesOverrides":[{"alias":"quota - requests","color":"#F2495C","dashes":true,"fill":0,"hiddenSeries":true,"hideTooltip":true,"legend":true,"linewidth":2,"stack":false},{"alias":"quota - limits","color":"#FF9830","dashes":true,"fill":0,"hiddenSeries":true,"hideTooltip":true,"legend":true,"linewidth":2,"stack":false}],"spaceLength":10,"stack":true,"steppedLine":false,"targets":[{"datasource":{"uid":"$datasource"},"editorMode":"code","expr":"sum(\n  node_namespace_pod_container:container_cpu_usage_seconds_total:sum_irate{namespace=\"$namespace\"}\n* on(namespace,pod)\n  group_left(workload, workload_type) namespace_workload_pod:kube_pod_owner:relabel{namespace=\"$namespace\"}\n) by (workload, workload_type)\n","format":"time_series","legendFormat":"{{workload}} - {{workload_type}}","range":true,"refId":"A"},{"datasource":{"uid":"$datasource"},"editorMode":"code","expr":"scalar(kube_resourcequota{namespace=\"$namespace\", type=\"hard\", resource=\"requests.cpu\"})","format":"time_series","legendFormat":"quota - requests","range":true,"refId":"B"},{"datasource":{"uid":"$datasource"},"editorMode":"code","expr":"scalar(kube_resourcequota{namespace=\"$namespace\", type=\"hard\",resource=\"limits.cpu\"})","format":"time_series","legendFormat":"quota - limits","range":true,"refId":"C"}],"thresholds":[],"timeRegions":[],"title":"CPU Usage","tooltip":{"shared":false,"sort":2,"value_type":"individual"},"type":"graph","xaxis":{"mode":"time","show":true,"values":[]},"yaxes":[{"format":"short","logBase":1,"min":0,"show":true},{"format":"short","logBase":1,"show":false}],"yaxis":{"align":false}},{"aliasColors":{},"bars":false,"dashLength":10,"dashes":false,"datasource":{"type":"prometheus","uid":"prometheus"},"fieldConfig":{"defaults":{"unitScale":true},"overrides":[]},"fill":10,"fillGradient":0,"gridPos":{"h":7,"w":24,"x":0,"y":23},"hiddenSeries":false,"id":5,"interval":"1m","legend":{"alignAsTable":true,"avg":false,"current":false,"max":false,"min":false,"rightSide":true,"show":true,"total":false,"values":false},"lines":true,"linewidth":0,"links":[],"nullPointMode":"null as zero","options":{"alertThreshold":true},"percentage":false,"pluginVersion":"10.3.3","pointradius":5,"points":false,"renderer":"flot","seriesOverrides":[{"alias":"quota - requests","color":"#F2495C","dashes":true,"fill":0,"hiddenSeries":true,"hideTooltip":true,"legend":true,"linewidth":2,"stack":false},{"alias":"quota - limits","color":"#FF9830","dashes":true,"fill":0,"hiddenSeries":true,"hideTooltip":true,"legend":true,"linewidth":2,"stack":false}],"spaceLength":10,"stack":true,"steppedLine":false,"targets":[{"datasource":{"uid":"$datasource"},"editorMode":"code","expr":"sum(\n    container_memory_working_set_bytes{job=\"kubelet\", metrics_path=\"/metrics/cadvisor\", namespace=\"$namespace\", container!=\"\", image!=\"\"}\n  * on(namespace,pod)\n    group_left(workload, workload_type) namespace_workload_pod:kube_pod_owner:relabel{namespace=\"$namespace\"}\n) by (workload, workload_type)\n","format":"time_series","legendFormat":"{{workload}} - {{workload_type}}","range":true,"refId":"A"},{"datasource":{"uid":"$datasource"},"editorMode":"code","expr":"scalar(kube_resourcequota{namespace=\"$namespace\", type=\"hard\",resource=\"requests.memory\"})","format":"time_series","legendFormat":"quota - requests","range":true,"refId":"B"},{"datasource":{"uid":"$datasource"},"editorMode":"code","expr":"scalar(kube_resourcequota{namespace=\"$namespace\", type=\"hard\",resource=\"limits.memory\"})","format":"time_series","legendFormat":"quota - limits","range":true,"refId":"C"}],"thresholds":[],"timeRegions":[],"title":"Memory Usage","tooltip":{"shared":false,"sort":2,"value_type":"individual"},"type":"graph","xaxis":{"mode":"time","show":true,"values":[]},"yaxes":[{"format":"bytes","logBase":1,"min":0,"show":true},{"format":"short","logBase":1,"show":false}],"yaxis":{"align":false}}],"refresh":"","schemaVersion":39,"tags":[],"templating":{"list":[{"current":{"selected":false,"text":"app","value":"app"},"hide":0,"name":"namespace","options":[{"selected":true,"text":"app","value":"app"}],"query":"app","skipUrlSync":false,"type":"textbox"}]},"time":{"from":"now-6h","to":"now"},"timepicker":{},"timezone": "`}}{{ .Values.grafana.defaultDashboardsTimezone }}{{`","title":"My APP monitoring","uid":"c4d8d209-bafe-4ee9-ba45-635b7c3660af","version":4,"weekStart":""}`}}
{{- end }}